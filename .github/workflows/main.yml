name: è‡ªåŠ¨ç”Ÿæˆé¢˜åº“ç´¢å¼•

on:
  push:
    paths:
      - 'data/*.json'
      - '!data/index.json'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“‚ æ£€æŸ¥ data æ–‡ä»¶å¤¹
        run: |
          echo "=== data æ–‡ä»¶å¤¹å†…å®¹ ==="
          ls -la data/
          echo ""
          echo "=== JSON æ–‡ä»¶åˆ—è¡¨ ==="
          find data -name "*.json" -type f
      
      - name: ğŸ”¨ ç”Ÿæˆé¢˜åº“ç´¢å¼•
        run: |
          echo "å¼€å§‹è¿è¡Œ generate-index.js"
          node generate-index.js
          echo ""
          echo "=== ç”Ÿæˆåçš„æ–‡ä»¶ ==="
          ls -la data/
      
      - name: ğŸ“„ æ˜¾ç¤ºç”Ÿæˆçš„ç´¢å¼•æ–‡ä»¶
        run: |
          if [ -f "data/index.json" ]; then
            echo "âœ… index.json å·²ç”Ÿæˆ"
            echo "=== æ–‡ä»¶å†…å®¹ ==="
            cat data/index.json
          else
            echo "âŒ index.json æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: ğŸ” æ£€æŸ¥å˜åŒ–
        id: check_changes
        run: |
          git add data/index.json
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°å˜åŒ–"
            git diff --cached --stat
          fi
      
      - name: ğŸ“¤ æäº¤ç´¢å¼•æ–‡ä»¶
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°é¢˜åº“ç´¢å¼• [skip ci]"
          
          echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git push
          
          echo "âœ… æ¨é€æˆåŠŸ"
      
      - name: âœ… å®Œæˆ
        run: |
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "é¢˜åº“ç´¢å¼•å·²è‡ªåŠ¨æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
          else
            echo "ç´¢å¼•æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
