name: è‡ªåŠ¨ç”Ÿæˆé¢˜åº“ç´¢å¼•

on:
  push:
    paths:
      - 'data/*.json'
      - '!data/index.json'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ”¨ ç”Ÿæˆé¢˜åº“ç´¢å¼•
        run: node generate-index.js
      
      - name: ğŸ“¤ æäº¤å¹¶æ¨é€
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # ç›´æ¥æ·»åŠ æ–‡ä»¶
          git add -f data/index.json
          
          # æäº¤ï¼ˆå³ä½¿æ²¡å˜åŒ–ä¹Ÿä¸ä¼šå¤±è´¥ï¼‰
          git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°é¢˜åº“ç´¢å¼•"
          
          # æ¨é€
          git push || echo "æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®"
      
      - name: âœ… éªŒè¯ç»“æœ
        run: |
          if git log -1 --pretty=%B | grep -q "è‡ªåŠ¨æ›´æ–°é¢˜åº“ç´¢å¼•"; then
            echo "âœ… æˆåŠŸæäº¤å¹¶æ¨é€ï¼"
          else
            echo "âš ï¸ å¯èƒ½æ²¡æœ‰å˜åŒ–æˆ–æ¨é€å¤±è´¥"
          fi
